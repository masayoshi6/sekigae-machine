<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>座席表 - 席替えアプリ</title>
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
    }

    .container {
        display: flex;
        gap: 30px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .seating-area {
        background-color: #4ECDC4;
        padding: 20px;
        border-radius: 10px;
        flex: 1;
    }

    .seating-title {
        color: white;
        text-align: center;
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: bold;
    }

    .seating-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        max-width: 400px;
        margin: 0 auto;
    }

    .seat {
        width: 80;
        height: 80px;
        background-color: white;
        border: 2px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .seat:hover {
        background-color: #f0f0f0;
        border-color: #333;
    }

    .seat.occupied {
        background-color: #ffb3ba;
        border-color: #ff6b7a;
    }

    .seat.male {
        background-color: #b3d9ff;
        border-color: #6bb6ff;
    }

    .seat.female {
        background-color: #ffb3e6;
        border-color: #ff6bcf;
    }

    .controls {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        flex: 1;
        height: fit-content;
    }

    .control-section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
    }

    .control-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
    }

    .button {
        background-color: #e91e63;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
        margin-bottom: 10px;
    }

    .button:hover {
        background-color: #c2185b;
    }

    .button.save {
        background-color: #4caf50;
    }

    .button.save:hover {
        background-color: #45a049;
    }

    .button.restore {
        background-color: #2196f3;
    }

    .button.restore:hover {
        background-color: #1976d2;
    }

    .button.delete {
        background-color: #f44336;
    }

    .button.delete:hover {
        background-color: #d32f2f;
    }

    .nav-links {
        margin-bottom: 20px;
    }

    .nav-links a {
        color: #333;
        text-decoration: none;
        margin-right: 15px;
    }

    .nav-links a:hover {
        text-decoration: underline;
    }

    .blackboard {
        background-color: #2d5a2d;
        color: white;
        text-align: center;
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 5px;
        font-weight: bold;
    }

    .shuffle-form {
        display: inline;
    }

    .constraint-options {
        margin-bottom: 15px;
    }

    .constraint-options label {
        display: block;
        margin-bottom: 8px;
        cursor: pointer;
    }

    .constraint-options input[type="checkbox"] {
        margin-right: 8px;
    }

    .snapshot-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        padding: 10px;
    }

    .snapshot-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #f0f0f0;
        margin-bottom: 5px;
    }

    .snapshot-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .snapshot-info {
        flex: 1;
    }

    .snapshot-name {
        font-weight: bold;
        font-size: 14px;
    }

    .snapshot-date {
        font-size: 12px;
        color: #666;
    }

    .snapshot-actions {
        display: flex;
        gap: 5px;
    }

    .small-button {
        padding: 4px 8px;
        font-size: 12px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
    }

    .message {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
    }

    .success-message {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .error-message {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .save-form {
        margin-bottom: 10px;
    }

    .save-form input[type="text"] {
        padding: 5px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 3px;
        width: 200px;
    }

    .save-form textarea {
        padding: 5px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 3px;
        width: 200px;
        height: 40px;
        resize: vertical;
    }
  </style>
</head>
<body>

<div class="nav-links">
  <a th:href="@{/students}">📋 生徒一覧</a>
  <a th:href="@{/students/new}">➕ 生徒追加</a>
  <a th:href="@{/}">🏠 ホーム</a>
</div>

<h1>🪑 席替えアプリケーション</h1>

<!-- メッセージ表示 -->
<div th:if="${successMessage}" class="message success-message" th:text="${successMessage}"></div>
<div th:if="${errorMessage}" class="message error-message" th:text="${errorMessage}"></div>

<div class="container">
  <!-- 座席表エリア -->
  <div class="seating-area">
    <div class="seating-title">今の座席 ℹ️</div>

    <!-- 黒板 -->
    <div class="blackboard">
      黒板
    </div>

    <!-- 座席グリッド -->
    <div class="seating-grid">
      <th:block th:each="row, rowStat : ${seatingChart}">
        <th:block th:each="seat, colStat : ${row}">
          <div class="seat"
               th:classappend="${seat != null} ? (${seat.gender} == '男子' ? ' male' : ' female') : ''"
               th:data-row="${rowStat.index + 1}"
               th:data-col="${colStat.index + 1}">
            <span th:text="${seat != null} ? ${seat.name} : ''"></span>
          </div>
        </th:block>
      </th:block>
    </div>
  </div>

  <!-- 制御パネル -->
  <div class="controls">
    <div class="control-section">
      <div class="control-title">🎯 条件</div>
      <p>席替えの条件を設定できます</p>
      <!-- TODO: 条件設定UI -->
    </div>

    <!-- 席替えフォーム -->
    <form class="shuffle-form" method="post" action="/seating/shuffle">
      <input type="hidden" name="rows" th:value="${rows != null ? rows : 6}">
      <input type="hidden" name="columns" th:value="${columns != null ? columns : 5}">

      <div class="control-section">
        <div class="control-title">🔄 制約で制限する</div>
        <div class="constraint-options">
          <label>
            <input type="checkbox" name="preventSameGender" id="preventSameGender">
            男女の座席を交互にする（チェスボードパターン）
          </label>
          <label>
            <input type="checkbox" name="alternateColumns" id="alternateColumns">
            列単位で男女を分ける（1列目：男子、2列目：女子...）
          </label>
        </div>
      </div>

      <div class="control-section">
        <div class="control-title">🎲 交換対象を絞って</div>
        <div class="constraint-options">
          <label>
            <input type="checkbox" name="specificStudents" id="specificStudents">
            交換対象生徒を選ぶ
          </label>
        </div>
      </div>

      <div class="control-section">
        <button type="submit" class="button">🔄 座替え</button>
      </div>
    </form>

    <!-- 座席保存フォーム -->
    <div class="control-section">
      <div class="control-title">💾 座席配置を保存</div>
      <form class="save-form" method="post" action="/seating/save">
        <input type="hidden" name="rows" th:value="${rows != null ? rows : 6}">
        <input type="hidden" name="columns" th:value="${columns != null ? columns : 5}">

        <div>
          <input type="text" name="snapshotName" placeholder="保存名（省略可）" maxlength="100">
        </div>
        <div>
          <textarea name="description" placeholder="説明（省略可）" maxlength="255"></textarea>
        </div>
        <button type="submit" class="button save">💾 現在の座席を保存</button>
      </form>
    </div>

    <!-- 保存された座席配置一覧 -->
    <div class="control-section" th:if="${snapshots != null and !snapshots.isEmpty()}">
      <div class="control-title">📁 保存された座席配置</div>
      <div class="snapshot-list">
        <div class="snapshot-item" th:each="snapshot : ${snapshots}">
          <div class="snapshot-info">
            <div class="snapshot-name" th:text="${snapshot.snapshotName}">座席配置名</div>
            <div class="snapshot-date"
                 th:text="${#temporals.format(snapshot.createdAt, 'yyyy-MM-dd HH:mm')}">
              2024-01-01 12:00
            </div>
            <div class="snapshot-date"
                 th:if="${snapshot.description != null and !snapshot.description.isEmpty()}"
                 th:text="'説明: ' + ${snapshot.description}">
              説明文
            </div>
          </div>
          <div class="snapshot-actions">
            <!-- 復元ボタン -->
            <form method="post" action="/seating/restore" style="display: inline;">
              <input type="hidden" name="snapshotId" th:value="${snapshot.id}">
              <button type="submit" class="small-button restore"
                      onclick="return confirm('この座席配置を復元しますか？現在の配置は失われます。')">
                復元
              </button>
            </form>
            <!-- 削除ボタン -->
            <form method="post" action="/seating/delete-snapshot" style="display: inline;">
              <input type="hidden" name="snapshotId" th:value="${snapshot.id}">
              <button type="submit" class="small-button delete"
                      onclick="return confirm('この保存データを削除しますか？')">
                削除
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 保存データがない場合のメッセージ -->
    <div class="control-section" th:if="${snapshots == null or snapshots.isEmpty()}">
      <div class="control-title">📁 保存された座席配置</div>
      <p style="color: #666; font-style: italic;">保存された座席配置はありません</p>
    </div>
  </div>
</div>

<script>
  // 座席クリック処理
  document.querySelectorAll('.seat').forEach(seat => {
      seat.addEventListener('click', function() {
          const row = this.dataset.row;
          const col = this.dataset.col;
          const studentName = this.textContent.trim();

          if (studentName) {
              alert(`座席 ${row}行${col}列: ${studentName}`);
          } else {
              alert(`座席 ${row}行${col}列: 空席`);
          }
      });
  });

  // チェックボックスの排他制御
  document.addEventListener('DOMContentLoaded', function() {
      const preventSameGender = document.getElementById('preventSameGender');
      const alternateColumns = document.getElementById('alternateColumns');

      // チェスボードパターンがチェックされたら列単位のチェックを外す
      preventSameGender.addEventListener('change', function() {
          if (this.checked) {
              alternateColumns.checked = false;
          }
      });

      // 列単位がチェックされたらチェスボードパターンのチェックを外す
      alternateColumns.addEventListener('change', function() {
          if (this.checked) {
              preventSameGender.checked = false;
          }
      });

      // 成功・エラーメッセージを自動で消す
      const messages = document.querySelectorAll('.message');
      messages.forEach(message => {
          setTimeout(() => {
              message.style.opacity = '0';
              setTimeout(() => {
                  message.remove();
              }, 300);
          }, 5000); // 5秒後に消える
      });
  });
</script>

</body>
</html>